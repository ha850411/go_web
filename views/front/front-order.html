<!--引入共用模板-->
{{ template "layout.html" .}}
{{ define "content" }}
<div class="main">
  <!-- MAIN CONTENT -->
  <div class="main-content">
    <div class="container-fluid">
      <h3 class="page-title">訂購單</h3>
      <div class="panel panel-headline">
        <div class="panel-body">
            <h3>訂購單</h3><br>
            <form action="/orders/add" method="POST" id="mainFm">

                <div class="form-group">
                    <label for="orders_name"><span style="color:#FF0000;">*</span>姓名:</label>
                    <input type="text" class="form-control" id="orders_name" name="name">
                </div>

                <div class="form-group">
                    <label for="orders_contact"><span style="color:#FF0000;">*</span>聯絡方式:</label>
                    <input type="text" class="form-control" id="orders_contact" name="contact">
                </div>

                <div class="form-group">
                    <label><span style="color:#FF0000;">*</span>商品名稱:</label>
                    <div>
                        <select class="select2-add-product" style="width:100%;">
                            <option value="">請選擇商品</option>
                        </select>
                        <input type="hidden" class="form-control" id="orders_pid" name="pid">
                    </div>
                </div>

                <div class="form-group">
                    <label for="orders_amount"><span style="color:#FF0000;">*</span>數量:</label>
                    <input type="number" class="form-control" id="orders_amount" name="amount">
                </div>

                <div class="form-group">
                    <label for="">備註:</label>
                    <textarea class="form-control" id="orders_remark" rows="3" name="remark"></textarea>
                </div>

                <div class="form-group">
                    <label for="modal_add_amount"><span style="color:#FF0000;">*</span>驗證碼:</label>
                    <canvas width="240" height="60" id="captcha"></canvas>
                </div>

                <input type="number" class="form-control" id="capchaInput" style="width:300px;" placeholder="請輸入驗證碼">

                <button type="button" class="btn btn-success" id="addSubmitBtn" style="margin-top:10px;">確定送出</button>
            </form>
        </div>
      </div>
    </div>
  </div>
  <!-- END MAIN CONTENT -->
</div>

<script>
var captchaCode = '';
$(function(){
    initSelect2();

    let captcha = new CaptchaMini({
        lineWidth: 1,
        lineNum: 3,
        dotR: 2,
        dotNum: 10,
        preGroundColor: [10, 80],
        backGroundColor: [150, 250],
        fontSize: 30,
        fontFamily: ['Georgia', 'Helvetica', 'Arial'],
        fontStyle: 'stroke', // fill & stroke
        content: '0123456789',
        length: 6
    }); 
    captcha.draw(document.querySelector('#captcha'), val => {
        captchaCode = val;
    });

    // 監聽商品名稱變化
    $('.select2-add-product').on('select2:select', function (e) {
        var data = e.params.data;
        $('#orders_pid').val(data.id);
    });

    $('#addSubmitBtn').click(function(){
        let require = [
            {el: '#orders_name', tip: '訂購人姓名為必填'},
            {el: '#orders_contact', tip: '聯絡方式為必填'},
            {el: '#orders_pid', tip: '請選擇商品'},
            {el: '#orders_amount', tip: '訂購數量為必填'},
        ];

        for (const key in require) {
            if($(require[key].el).val().length == 0) {
                alert(require[key].tip);
                $(require[key].el).focus();
                return false;
            }
        }
        if($('#capchaInput').val().length == 0) {
            alert('驗證碼為必填');
            $('#capchaInput').focus();
            return false;
        }
        if($('#capchaInput').val() !== captchaCode) {
            alert('驗證碼錯誤!');
            $('#captcha').click()
            $('#capchaInput').focus();
            return false;
        }
        $('#mainFm').submit()
    });
});

async function initSelect2(){
    try {
        const response = await axios.get('/api/products/getProductsNameList');
        results = response.data.results;
        $(".select2-add-product").select2({
            placeholder: '請輸入商品名稱',
            data: results,
        });
        $(".select2-edit-product").select2({
            placeholder: '請輸入商品名稱',
            data: results,
        });
    } catch (error) {
        console.log(error);
    }
}

</script>
{{end}}